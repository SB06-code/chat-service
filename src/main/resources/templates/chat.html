<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="|ì±„íŒ…ë°©: ${roomId}|">ì±„íŒ…ë°©</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            background-color: #007bff;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header-left h1 {
            margin: 0;
            font-size: 1.5em;
        }

        .header-right {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .status {
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 0.9em;
            font-weight: bold;
        }

        .connected {
            background-color: #28a745;
        }

        .disconnected {
            background-color: #dc3545;
        }

        .leave-button {
            padding: 8px 15px;
            background-color: #dc3545;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9em;
        }

        .leave-button:hover {
            background-color: #c82333;
        }

        .chat-container {
            flex: 1;
            display: flex;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
            margin: 10px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .messages-area {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            background-color: #fafafa;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            max-width: 70%;
            word-wrap: break-word;
        }

        .message.own {
            background-color: #007bff;
            color: white;
            margin-left: auto;
        }

        .message.other {
            background-color: white;
            border: 1px solid #dee2e6;
        }

        .message.system {
            background-color: #e7f3ff;
            color: #004085;
            text-align: center;
            margin: 10px auto;
            max-width: 90%;
            font-style: italic;
        }

        .message-header {
            font-size: 0.85em;
            margin-bottom: 5px;
            opacity: 0.8;
            font-weight: bold;
        }

        .message-content {
            line-height: 1.4;
        }

        .input-area {
            padding: 20px;
            background-color: white;
            border-top: 1px solid #dee2e6;
            display: flex;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #dee2e6;
            border-radius: 25px;
            outline: none;
            font-size: 16px;
        }

        .message-input:focus {
            border-color: #007bff;
        }

        .send-button {
            padding: 12px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            font-size: 16px;
            min-width: 80px;
        }

        .send-button:hover {
            background-color: #0056b3;
        }

        .send-button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .sidebar {
            width: 250px;
            background: white;
            margin: 10px 10px 10px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            padding: 20px;
        }

        .sidebar h3 {
            margin-top: 0;
            color: #333;
            border-bottom: 2px solid #007bff;
            padding-bottom: 10px;
        }

        .user-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .user-item {
            padding: 8px 12px;
            margin: 5px 0;
            background-color: #f8f9fa;
            border-radius: 5px;
            border-left: 3px solid #007bff;
        }

        .user-count {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
        }

        @media (max-width: 768px) {
            .chat-container {
                flex-direction: column;
            }

            .sidebar {
                width: auto;
                margin: 0 10px 10px 10px;
                order: -1;
            }

            .chat-main {
                margin: 0 10px 10px 10px;
            }
        }
    </style>
</head>
<body>
<div class="chat-header">
    <div class="header-left">
        <h1 th:text="|ğŸ“ ${roomId} ì±„íŒ…ë°©|">ì±„íŒ…ë°©</h1>
    </div>
    <div class="header-right">
        <span id="username" th:text="${username}">ì‚¬ìš©ì</span>
        <span id="connectionStatus" class="status disconnected">ì—°ê²° ì¤‘...</span>
        <button class="leave-button" onclick="leaveChat()">ë‚˜ê°€ê¸°</button>
    </div>
</div>

<div class="chat-container">
    <div class="chat-main">
        <div class="messages-area" id="messagesArea">
            <!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>

        <div class="input-area">
            <input type="text" id="messageInput" class="message-input"
                   placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." disabled maxlength="500">
            <button id="sendButton" class="send-button" disabled>ì „ì†¡</button>
        </div>
    </div>

    <div class="sidebar">
        <h3>ì˜¨ë¼ì¸ ì‚¬ìš©ì</h3>
        <div class="user-count" id="userCount">0ëª… ì ‘ì† ì¤‘</div>
        <ul class="user-list" id="userList">
            <!-- ì‚¬ìš©ì ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </ul>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/sockjs-client@1.6.1/dist/sockjs.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@stomp/stompjs@7.0.0/bundles/stomp.umd.min.js"></script>
<script th:inline="javascript">
    // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ ë°ì´í„°
    const roomId = /*[[${roomId}]]*/ 'general';
    const username = /*[[${username}]]*/ 'ì‚¬ìš©ì';

    // URLì—ì„œ í† í° ì¶”ì¶œ
    const urlParams = new URLSearchParams(window.location.search);
    const token = urlParams.get('token');

    let stompClient = null;
    let isConnected = false;

    // ì¬ì—°ê²° ê´€ë¦¬ë¥¼ ìœ„í•œ ì „ì—­ ë³€ìˆ˜
    let connectionAttempts = 0;
    let maxReconnectAttempts = 5;
    let baseReconnectDelay = 1000; // 1ì´ˆ
    let reconnectTimeout = null;
    let isIntentionalDisconnect = false;

    // DOM ìš”ì†Œë“¤
    const messagesArea = document.getElementById('messagesArea');
    const messageInput = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const connectionStatus = document.getElementById('connectionStatus');
    const userList = document.getElementById('userList');
    const userCount = document.getElementById('userCount');

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í† í° ê²€ì¦ ë° ìë™ ì—°ê²°
    window.addEventListener('load', function() {
        if (!username || username.trim() === '' || !token) {
            alert('ì¸ì¦ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            window.location.href = '/';
            return;
        }
        connect();
    });

    function connect() {
        // ì´ë¯¸ ì—°ê²° ì¤‘ì´ê±°ë‚˜ ì—°ê²°ëœ ìƒíƒœë©´ ì¤‘ë³µ ì—°ê²° ë°©ì§€
        if (stompClient && (isConnected || stompClient.state === 'CONNECTING')) {
            console.log('ì´ë¯¸ ì—°ê²° ì¤‘ì´ê±°ë‚˜ ì—°ê²°ëœ ìƒíƒœì…ë‹ˆë‹¤.');
            return;
        }

        // ê¸°ì¡´ ì¬ì—°ê²° íƒ€ì´ë¨¸ê°€ ìˆìœ¼ë©´ ì·¨ì†Œ
        if (reconnectTimeout) {
            clearTimeout(reconnectTimeout);
            reconnectTimeout = null;
        }

        console.log(`ì—°ê²° ì‹œë„ #${connectionAttempts + 1}`);

        // í† í°ì„ URL íŒŒë¼ë¯¸í„°ë¡œ ì „ë‹¬í•˜ì—¬ WebSocket ì—°ê²°
        stompClient = new StompJs.Client({
            brokerURL: `ws://localhost:8080/ws?token=${encodeURIComponent(token)}`,
            connectHeaders: {},
            debug: function (str) {
                console.log(str);
            },
            // ìë™ ì¬ì—°ê²° ë¹„í™œì„±í™” - ìˆ˜ë™ìœ¼ë¡œ ê´€ë¦¬
            reconnectDelay: 0,
            // í•˜íŠ¸ë¹„íŠ¸ ì„¤ì •ì„ ì„œë²„ì™€ ë§ì¶¤
            heartbeatIncoming: 20000, // 20ì´ˆ
            heartbeatOutgoing: 10000, // 10ì´ˆ
        });

        stompClient.onConnect = function(frame) {
            console.log('Connected: ' + frame);
            isConnected = true;
            connectionAttempts = 0; // ì„±ê³µ ì‹œ ì¬ì—°ê²° ì¹´ìš´í„° ë¦¬ì…‹
            updateConnectionStatus('ì—°ê²°ë¨', true);
            enableInput(true);

            // ì±„íŒ…ë°© ë©”ì‹œì§€ êµ¬ë…
            stompClient.subscribe('/topic/chat/' + roomId, function(message) {
                const chatMessage = JSON.parse(message.body);
                displayMessage(chatMessage);
            });

            // ì‚¬ìš©ì ëª©ë¡ êµ¬ë…
            stompClient.subscribe('/topic/chat/' + roomId + '/users', function(message) {
                const users = JSON.parse(message.body);
                updateUserList(users);
            });

            // ì±„íŒ…ë°© ì…ì¥
            joinRoom();
        };

        stompClient.onStompError = function(frame) {
            console.error('STOMP ì—ëŸ¬:', frame);
            isConnected = false;
            enableInput(false);

            // ì—ëŸ¬ í—¤ë”ì—ì„œ ì¸ì¦ ì—ëŸ¬ í™•ì¸
            const authError = frame.headers['X-Auth-Error'];

            if (authError === 'TOKEN_INVALID' || authError === 'TOKEN_ERROR') {
                // ì¸ì¦ ì—ëŸ¬ëŠ” ì¬ì—°ê²°í•˜ì§€ ì•Šê³  ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™
                updateConnectionStatus('ì¸ì¦ ë§Œë£Œ', false);
                alert('ì¸ì¦ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
                window.location.href = '/';
                return;
            }

            // ê¸°íƒ€ ì—ëŸ¬ëŠ” ì¬ì—°ê²° ì‹œë„
            updateConnectionStatus('ì—°ê²° ì‹¤íŒ¨', false);
            attemptReconnect();
        };

        stompClient.onWebSocketClose = function(event) {
            console.log('WebSocket ë‹«í˜:', event);
            isConnected = false;
            enableInput(false);

            if (!isIntentionalDisconnect) {
                updateConnectionStatus('ì—°ê²° ëŠì–´ì§', false);
                attemptReconnect();
            }
        };

        stompClient.onWebSocketError = function(error) {
            console.error('WebSocket ì—ëŸ¬:', error);
            isConnected = false;
            enableInput(false);
            updateConnectionStatus('ì—°ê²° ì˜¤ë¥˜', false);
            attemptReconnect();
        };

        try {
            stompClient.activate();
        } catch (error) {
            console.error('ì—°ê²° ì‹œë„ ì¤‘ ì˜¤ë¥˜:', error);
            attemptReconnect();
        }
    }

    function attemptReconnect() {
        // ì˜ë„ì  ì—°ê²° í•´ì œì¸ ê²½ìš° ì¬ì—°ê²°í•˜ì§€ ì•ŠìŒ
        if (isIntentionalDisconnect) {
            return;
        }

        connectionAttempts++;

        if (connectionAttempts > maxReconnectAttempts) {
            updateConnectionStatus('ì—°ê²° í¬ê¸°', false);
            alert('ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
            return;
        }

        // ì§€ìˆ˜ ë°±ì˜¤í”„ ì ìš©: 1ì´ˆ, 2ì´ˆ, 4ì´ˆ, 8ì´ˆ, 16ì´ˆ
        const delay = Math.min(baseReconnectDelay * Math.pow(2, connectionAttempts - 1), 30000);

        updateConnectionStatus(`${delay/1000}ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„...`, false);

        reconnectTimeout = setTimeout(() => {
            if (!isIntentionalDisconnect) {
                connect();
            }
        }, delay);
    }

    function disconnect() {
        isIntentionalDisconnect = true;

        // ì¬ì—°ê²° íƒ€ì´ë¨¸ ì·¨ì†Œ
        if (reconnectTimeout) {
            clearTimeout(reconnectTimeout);
            reconnectTimeout = null;
        }

        if (stompClient && isConnected) {
            stompClient.deactivate();
        }

        isConnected = false;
        enableInput(false);
        updateConnectionStatus('ì—°ê²° í•´ì œë¨', false);
    }

    function joinRoom() {
        if (stompClient && isConnected) {
            const joinMessage = {
                type: 'JOIN',
                sender: username,
                roomId: roomId
            };

            try {
                stompClient.publish({
                    destination: '/app/chat/' + roomId + '/join',
                    body: JSON.stringify(joinMessage)
                });
            } catch (error) {
                console.error('ì±„íŒ…ë°© ì…ì¥ ì‹¤íŒ¨:', error);
            }
        }
    }

    function sendMessage() {
        const messageContent = messageInput.value.trim();
        if (messageContent && isConnected) {
            const message = {
                type: 'CHAT',
                content: messageContent,
                sender: username,
                roomId: roomId
            };

            try {
                stompClient.publish({
                    destination: '/app/chat/' + roomId,
                    body: JSON.stringify(message)
                });
                messageInput.value = '';
                messageInput.focus();
            } catch (error) {
                console.error('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨:', error);
                updateConnectionStatus('ë©”ì‹œì§€ ì „ì†¡ ì‹¤íŒ¨', false);
            }
        }
    }

    function displayMessage(message) {
        const messageDiv = document.createElement('div');

        let messageClass = 'message';
        if (message.type === 'JOIN' || message.type === 'LEAVE') {
            messageClass += ' system';
        } else if (message.sender === username) {
            messageClass += ' own';
        } else {
            messageClass += ' other';
        }

        messageDiv.className = messageClass;

        if (message.type === 'CHAT') {
            const time = new Date(message.timestamp).toLocaleTimeString();

            const headerDiv = document.createElement('div');
            headerDiv.className = 'message-header';
            headerDiv.textContent = `${message.sender} â€¢ ${time}`;

            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = message.content;

            messageDiv.appendChild(headerDiv);
            messageDiv.appendChild(contentDiv);
        } else {
            const contentDiv = document.createElement('div');
            contentDiv.className = 'message-content';
            contentDiv.textContent = message.content;
            messageDiv.appendChild(contentDiv);
        }

        messagesArea.appendChild(messageDiv);
        messagesArea.scrollTop = messagesArea.scrollHeight;
    }

    function updateUserList(users) {
        userList.innerHTML = '';
        const userNames = [];

        for (const sessionId in users) {
            const user = users[sessionId];
            userNames.push(user.username);

            const li = document.createElement('li');
            li.className = 'user-item';
            li.textContent = user.username;
            userList.appendChild(li);
        }

        userCount.textContent = `${userNames.length}ëª… ì ‘ì† ì¤‘`;
    }

    function updateConnectionStatus(message, connected) {
        connectionStatus.textContent = message;
        connectionStatus.className = 'status ' + (connected ? 'connected' : 'disconnected');
    }

    function enableInput(enabled) {
        messageInput.disabled = !enabled;
        sendButton.disabled = !enabled;
        if (enabled) {
            messageInput.focus();
        }
    }

    function leaveChat() {
        if (confirm('ì±„íŒ…ë°©ì„ ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            disconnect();
            window.location.href = '/';
        }
    }

    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
    sendButton.addEventListener('click', sendMessage);
    messageInput.addEventListener('keypress', function(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    });

    // í˜ì´ì§€ ë‚˜ê°ˆ ë•Œ ì—°ê²° í•´ì œ
    window.addEventListener('beforeunload', function() {
        disconnect();
    });

    // í˜ì´ì§€ ê°€ì‹œì„± ë³€ê²½ ì²˜ë¦¬ (ëª¨ë°”ì¼ì—ì„œ ì¤‘ìš”)
    document.addEventListener('visibilitychange', function() {
        if (document.hidden) {
            // í˜ì´ì§€ê°€ ìˆ¨ê²¨ì¡Œì„ ë•Œ - ì•„ë¬´ê²ƒë„ í•˜ì§€ ì•ŠìŒ
            console.log('í˜ì´ì§€ ìˆ¨ê²¨ì§');
        } else {
            // í˜ì´ì§€ê°€ ë‹¤ì‹œ ë³´ì¼ ë•Œ - ì—°ê²° ìƒíƒœ í™•ì¸
            console.log('í˜ì´ì§€ ë‹¤ì‹œ ë³´ì„');
            if (!isConnected && !isIntentionalDisconnect) {
                console.log('í˜ì´ì§€ ë³µì› ì‹œ ì¬ì—°ê²° ì‹œë„');
                connectionAttempts = 0; // ì¹´ìš´í„° ë¦¬ì…‹
                connect();
            }
        }
    });
</script>
</body>
</html>